<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>lib/sles4sap/sap_deployment_automation_framework/networking.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel='stylesheet' href='../../style.css' />
</head>

<body>



<ul id="index"><li><a href="../../index.html"><i>&lt;= Back to file list</i></a></li>
  <li><a href="#SYNOPSIS">SYNOPSIS</a>
    <ul>
      <li><a href="#calculate_net_addr_space">calculate_net_addr_space</a></li>
      <li><a href="#calculate_subnets">calculate_subnets</a></li>
      <li><a href="#list_expired_files">list_expired_files</a></li>
      <li><a href="#list_network_lease_files">list_network_lease_files</a></li>
      <li><a href="#acquire_network_file_lease">acquire_network_file_lease</a></li>
      <li><a href="#deployer_peering_exists">deployer_peering_exists</a></li>
      <li><a href="#assign_defined_network">assign_defined_network</a></li>
      <li><a href="#create_lease_file">create_lease_file</a></li>
      <li><a href="#create_new_address_space">create_new_address_space</a></li>
      <li><a href="#assign_address_space">assign_address_space</a></li>
    </ul>
  </li>
</ul><h1>lib/sles4sap/sap_deployment_automation_framework/networking.pm</h1>

<h1 id="SYNOPSIS">SYNOPSIS</h1>

<p>Library with common functions for Microsoft SDAF deployment automation related to networking setup.</p>

<h2 id="calculate_net_addr_space">calculate_net_addr_space</h2>

<pre><code>calculate_net_addr_space();</code></pre>

<p>Calculate network IP space that will be reserved to contain all underlying subnets: &#39;admin&#39;, &#39;db&#39;, &#39;app&#39;, &#39;web&#39;. Each network space will reserve 64 IP addresses. This splits last IP octet into 4 network spaces. First 64 address spaces are used from third octet, making 256 network spaces available for all OpenQA tests at any point in time. (256 tests can run at the same time using one control plane.)</p>

<p>Random network space pick is only performance related. If the pick was in orderly manner it would mean that from for example 5 parallel tests, one test will spend 5 loops to get a free network.</p>

<h2 id="calculate_subnets">calculate_subnets</h2>

<pre><code>calculate_subnets([network_space=&gt;&#39;192.168.0.0&#39;]);</code></pre>

<dl>

<dt id="network_space:-Define-network-space-to-calculate-subnets-for.-Will-be-generated-if-left-undefined"><b>network_space</b>: Define network space to calculate subnets for. Will be generated if left undefined.</dt>
<dd>

</dd>
</dl>

<p>Calculates 4 subnets required by SDAF within a network space. If network space is not specified, it will be generated by <b>calculate_net_addr_space</b>. Check mentioned function for details. Network space is set to reserve 64 IP addresses which will be split into 4 subnets: &#39;db&#39;, &#39;app&#39;, &#39;web&#39;, &#39;admin&#39; This leaves 16 IP addresses for each subnet. (only 14 are usable).</p>

<h2 id="list_expired_files">list_expired_files</h2>

<pre><code>list_expired_files($check_older_than_sec);</code></pre>

<dl>

<dt id="check_older_than_sec:-Check-only-files-with-modification-time-older-than-parameter-value-in-seconds"><b>$check_older_than_sec</b>: Check only files with modification time older than parameter value in seconds</dt>
<dd>

</dd>
</dl>

<p>Returns names of lease blob files within &#39;network-spaces&#39; container which are older than retention time. Test will search network spaces which were reserved more than <b>$check_older_than_sec</b> seconds ago. Default 7h should be plenty for not triggering race condition between network assignment and actual infrastructure creation.</p>

<h2 id="list_network_lease_files">list_network_lease_files</h2>

<pre><code>list_network_lease_files();</code></pre>

<p>Returns names of all lease blob files within &#39;network-spaces&#39; container.</p>

<h2 id="acquire_network_file_lease">acquire_network_file_lease</h2>

<pre><code>acquire_network_file_lease(network_lease_file=&gt;&#39;192.168.1.0&#39; [, storage_account=&gt;&#39;some account&#39;]);</code></pre>

<dl>

<dt id="storage_account:-Storage-account-containing-lease-file.-Default:-SDAF_TFSTATE_STORAGE_ACCOUNT"><b>storage_account</b>: Storage account containing lease file. Default: &#39;SDAF_TFSTATE_STORAGE_ACCOUNT&#39;</dt>
<dd>

</dd>
<dt id="network_lease_file:-Name-of-the-lease-file"><b>network_lease_file</b>: Name of the lease file</dt>
<dd>

</dd>
</dl>

<p>Acquire network lease for a blob. Returns blob lease UUID which is later required for getting permission to modify blob file.</p>

<h2 id="deployer_peering_exists">deployer_peering_exists</h2>

<pre><code>deployer_peering_exists(addr_space=&gt;&#39;192.168.0.0&#39;, deployer_vnet_name=&gt;&#39;SHODAN-vnet&#39;);</code></pre>

<dl>

<dt id="addr_space:-Address-space-to-check-for.-Must-include-subnet-prefix"><b>addr_space</b>: Address space to check for. Must include subnet prefix.</dt>
<dd>

</dd>
<dt id="deployer_vnet_name:-Deployer-virtual-network-name"><b>deployer_vnet_name</b>: Deployer virtual network name</dt>
<dd>

</dd>
</dl>

<p>Checks if there is already a network peering established between deployer virtual network and address space specified by <b>addr_space</b>.</p>

<h2 id="assign_defined_network">assign_defined_network</h2>

<pre><code>assign_defined_network(deployer_vnet_name=&gt;&#39;SHODAN-vnet&#39; [, networks_older_than=&gt;3600]);</code></pre>

<dl>

<dt id="networks_older_than:-Check-for-networks-older-than-parameter-value-in-seconds"><b>networks_older_than</b>: Check for networks older than parameter value in seconds.</dt>
<dd>

</dd>
<dt id="deployer_vnet_name:-Deployer-virtual-network-name1"><b>deployer_vnet_name</b>: Deployer virtual network name</dt>
<dd>

</dd>
</dl>

<p>Assign network that has already lease file present in storage account. Lists existing network files which were modified more than <b>$args{networks_older_than}</b> seconds in the past and picks one of the files at random. A check is performed if the network space is already peered to deployer virtual network <b>deployer_vnet_name</b>. Last step is to attempt to assign a blob lease for the network file associated. Blob file lease serves as a locking mechanism to prevent multiple tests assign same network space, causing collisions.</p>

<p>For a successful network assignment three criteria must be met: - there is blob file that represents a network space in storage account (check list_expired_files()) - network peering between network space and deployer virtual network does not exist - function is able to assign a 60s blob file lease to reserve exclusive network rights</p>

<p>Argument <b>networks_older_than</b> value should be greater than time between the start of this function and <b>lib/sles4sap/sap_deployment_automation_framework sdaf_execute_deployment()</b> creating network resources. This serves to prevent a race condition where a test picks network space which another test already assigned but haven&#39;t created network resources yet.</p>

<p><b>There are multiple ways to handle this:</b> <b>A.</b> set <b>networks_older_than</b> to larger value than (timeout + retry) arguments set for sdaf_execute_deployment(timeout=&gt;$timeout, retry=&gt;$retry). This means test won&#39;t search for networks which are still possibly being created by terraform. Check <b>tests/sles4sap/sap_deployment_automation_framework/deploy_workload_zone.pm</b> for example.</p>

<p><b>B.</b> Set it to some arbitrarily high but acceptable value like default 7 hours. This should be enough for any terraform deployment either to finish or fail.</p>

<h2 id="create_lease_file">create_lease_file</h2>

<pre><code>create_lease_file(network_space=&gt;&#39;192.168.1.0&#39; [, storage_account=&gt;&#39;SHODAN-storage&#39;]);</code></pre>

<dl>

<dt id="storage_account:-Storage-account-containing-lease-file"><b>storage_account</b>: Storage account containing lease file</dt>
<dd>

</dd>
<dt id="network_space:-Network-space-to-create-the-lease-file-for"><b>network_space</b>: Network space to create the lease file for</dt>
<dd>

</dd>
</dl>

<p>Creates an uploads new network lease file</p>

<h2 id="create_new_address_space">create_new_address_space</h2>

<pre><code>create_new_address_space(deployer_vnet_name=&gt;&#39;SHODAN-vnet&#39; [, timeout=&gt;9001]);</code></pre>

<dl>

<dt id="deployer_vnet_name:-Deployer-virtual-network"><b>deployer_vnet_name</b>: Deployer virtual network</dt>
<dd>

</dd>
<dt id="timeout:-Timeout-for-creating-new-lease-file"><b>timeout</b>: Timeout for creating new lease file</dt>
<dd>

</dd>
</dl>

<p>Used to assign network space which does not yet have blob file created in &#39;SDAF_TFSTATE_STORAGE_ACCOUNT&#39; storage account. Function generates random address space and checks for an existing lease file in storage account. If file does not exist it will be created, otherwise function searches again for network space without existing file. Before assigning network space there is a check for an existing peering between this network and deployer vnet. This is to avoid assigning network which was created without a lease file.</p>

<h2 id="assign_address_space">assign_address_space</h2>

<pre><code>assign_address_space([networks_older_than=&gt;3600]);</code></pre>

<dl>

<dt id="networks_older_than:-Check-for-networks-older-than-parameter-value-in-seconds1"><b>networks_older_than</b>: Check for networks older than parameter value in seconds.</dt>
<dd>

</dd>
</dl>

<p>Assigns an unused address space either by leasing existing network file inside storage account or creates a new file in case there are no free existing lease files. Check functions <b>assign_defined_network</b> and <b>create_new_address_space</b> for details about the process.</p>


</body>

</html>


