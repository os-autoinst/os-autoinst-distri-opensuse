<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>lib/sles4sap/sap_deployment_automation_framework/deployment_connector.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel='stylesheet' href='../../style.css' />
</head>

<body>



<ul id="index"><li><a href="../../index.html"><i>&lt;= Back to file list</i></a></li>
  <li><a href="#SYNOPSIS">SYNOPSIS</a>
    <ul>
      <li><a href="#check_ssh_availability">check_ssh_availability</a></li>
      <li><a href="#get_deployer_ip">get_deployer_ip</a></li>
      <li><a href="#get_deployer_vm_name">get_deployer_vm_name</a></li>
      <li><a href="#get_parent_ids">get_parent_ids</a></li>
      <li><a href="#find_deployment_id">find_deployment_id</a></li>
      <li><a href="#get_deployer_resources">get_deployer_resources</a></li>
      <li><a href="#destroy_resources">destroy_resources</a></li>
      <li><a href="#destroy_deployer_vm">destroy_deployer_vm</a></li>
      <li><a href="#destroy_orphaned_deployers">destroy_orphaned_deployers</a></li>
      <li><a href="#destroy_orphaned_peerings">destroy_orphaned_peerings</a></li>
      <li><a href="#no_cleanup_tag">no_cleanup_tag</a></li>
    </ul>
  </li>
</ul><h1>lib/sles4sap/sap_deployment_automation_framework/deployment_connector.pm</h1>

<h1 id="SYNOPSIS">SYNOPSIS</h1>

<p>This library contains various functions that help finding and connecting openQA job to the correct deployment VM. Deployment VM is recognized from other VMs by being tagged with <b>deployment_id</b> tag. Deployment ID is an unique identifier which is an OpenQA job ID of a job that created this VM. In single machine test Deployment ID equals test ID. This is not always true in case of multi-machine jobs. Deployment ID might be an ID of the parent job which executed the deployment itself.</p>

<p><b>Example</b>: Job: 123456 - deployment module - created deployer VM tagged with &quot;deployment_id=123456&quot;, Job: 123457 (child of 123456) - some test module Deployment ID returned from both jobs: 123456 - because it matches with existing VM tagged with &quot;deployment_id=123456&quot;</p>

<h2 id="check_ssh_availability">check_ssh_availability</h2>

<pre><code>check_ssh_availability($deployer_ip_addr [, ssh_port=&gt;42 ,$wait_started=&gt;&#39;true&#39;, wait_timeout=&gt;&#39;42&#39;]);</code></pre>

<p>Checks if deployer VM is running and listening on ssh port. Returns found state. Optionally function can wait till VM reaches requested state until timeout. Function dies only with internal errors, VM status should be evaluated and handled by caller.</p>

<ul>

<li><p><b>deployer_ip_addr</b>: Deployer VM IP address</p>

</li>
<li><p><b>wait_started</b>: Probe SSH port in loop until it is available or <b>wait_timeout</b> is reached.</p>

</li>
<li><p><b>wait_timeout</b>: Time in sec to stop probing SSH port.</p>

</li>
<li><p><b>ssh_port</b>: Specify custom SSH port number. Default: 22</p>

</li>
</ul>

<h2 id="get_deployer_ip">get_deployer_ip</h2>

<pre><code>get_deployer_ip(deployer_resource_group=&gt;$deployer_resource_group, deployer_vm_name=&gt;$deployer_vm_name);</code></pre>

<p>Returns first public IP of deployer VM that is reachable and can be used for SDAF deployment connection.</p>

<ul>

<li><p><b>deployer_resource_group</b>: Deployer resource group. Default: get_required_var(&#39;SDAF_DEPLOYER_RESOURCE_GROUP&#39;)</p>

</li>
<li><p><b>deployer_vm_name</b>: Deployer VM resource name</p>

</li>
</ul>

<h2 id="get_deployer_vm_name">get_deployer_vm_name</h2>

<pre><code>get_deployer_vm_name(deployer_resource_group=&gt;$deployer_resource_group, deployment_id=&gt;&#39;123456&#39;);</code></pre>

<p>Returns deployer VM name which is tagged with <b>deployment_id</b> specified in parameter. This means that the VM was used to deploy the infrastructure under this ID and contains whole SDAF setup. Function returns VM name or undef if no VM was found. Function dies if there is more than one VM found, because two VM&#39;s must not have same ID.</p>

<ul>

<li><p><b>deployer_resource_group</b>: Deployer resource group. Default: get_required_var(&#39;SDAF_DEPLOYER_RESOURCE_GROUP&#39;)</p>

</li>
<li><p><b>deployment_id</b>: Deployment ID</p>

</li>
</ul>

<h2 id="get_parent_ids">get_parent_ids</h2>

<pre><code>get_parent_ids();</code></pre>

<p>Returns <b>ARRAYREF</b> of all parent job IDs acquired from job data.</p>

<ul>

<li><p><b>job_id</b>: Job ID which parents should be listed</p>

</li>
</ul>

<h2 id="find_deployment_id">find_deployment_id</h2>

<pre><code>find_deployment_id(deployer_resource_group=&gt;$deployer_resource_group);</code></pre>

<p>Finds deployment ID for currently running test. Deployment ID is ID of an OpenQA test which created deployer VM. In case of multi-machine test this can be either parent test ID or current job id as well. This function collects all OpenQA job IDs related to current test run and checks if any of them match an existing deployer VM tagged with this ID.</p>

<p>Using OpenQA parameter <b>SDAF_DEPLOYMENT_ID</b> it is possible to override this value. It is mostly intended for development purposes where it allows you to run test code on already existing deployment. Use it with caution and override the value only with ID of the infrastructure that belongs to you.</p>

<p><b>Example</b>: Job: 123456 - deployment module - created deployer VM tagged with &quot;deployment_id=123456&quot;, Job: 123457 (child of 123456) - some test module Deployment ID returned from both jobs: 123456 - because it matches with existing VM tagged with &quot;deployment_id=123456&quot;</p>

<ul>

<li><p><b>deployer_resource_group</b>: Deployer resource group. Default: get_required_var(&#39;SDAF_DEPLOYER_RESOURCE_GROUP&#39;)</p>

</li>
</ul>

<h2 id="get_deployer_resources">get_deployer_resources</h2>

<pre><code>get_deployer_resources(deployer_resource_group=&gt;$deployer_resource_group [, deployment_id=&gt;&#39;123456&#39;, return_ids=1]);</code></pre>

<p>Returns ARRAYREF of all resources belonging to <b>deployer_resource_group</b> tagged with <b>deployment_id</b>.</p>

<ul>

<li><p><b>deployer_resource_group</b>: Deployer resource group. Default: get_required_var(&#39;SDAF_DEPLOYER_RESOURCE_GROUP&#39;)</p>

</li>
<li><p><b>deployment_id</b>: Deployment ID</p>

</li>
<li><p><b>return_value</b>: Control the content of the returned array. It can either return array of resource IDs or resource names. Values allowed: id, name Default: name</p>

</li>
</ul>

<h2 id="destroy_resources">destroy_resources</h2>

<pre><code>destroy_resources(resource_cleanup_list=&gt;[&#39;resource_A&#39;, &#39;resource_B&#39;] [, timeout=&gt;900]);</code></pre>

<p>Destroys all resources specified by <b>resources</b> argument in ARRAYREF format.</p>

<ul>

<li><p><b>timeout</b> Timeout for AZ command to destroy resources. Default: 800</p>

</li>
<li><p><b>resource_cleanup_list</b> ARRAYREF specifying resources to be deleted. If empty, function will just return.</p>

</li>
</ul>

<h2 id="destroy_deployer_vm">destroy_deployer_vm</h2>

<pre><code>destroy_deployer_vm([timeout=&gt;900]);</code></pre>

<p>Collects resource id of all resources belonging to the deployer VM and deletes them. Cleanup deployer VM resources only, <b>deployer resource group itself will stay intact</b>.</p>

<ul>

<li><p><b>timeout</b>: Timeout for destroy command. Default: 800</p>

</li>
</ul>

<h2 id="destroy_orphaned_deployers">destroy_orphaned_deployers</h2>

<pre><code>destroy_orphaned_deployers([timeout=&gt;9999]);</code></pre>

<p>Destroys orphaned deployer VM resources existing inside permanent deployer resource group. Function lists all resources and their creation time belonging to deployer RG which are tagged with &#39;deployment_id&#39;. Resource being tagged with &#39;deployment_id&#39; means it was created by an OpenQA test. Resource names are as well checked against OpenQA naming convention as another prevention from unwanted resource deletion. Resources older than &#39;SDAF_DEPLOYER_VM_RETENTION_SEC&#39; seconds (Default 7H) are considered as orphans and deleted. Be very careful with changes here (especially with regexes and az cli filters) as mistakes can lead to damage on permanent SDAF infrastructure.</p>

<ul>

<li><p><b>timeout</b>: Timeout for az destroy command. Default: 1200</p>

</li>
</ul>

<h2 id="destroy_orphaned_peerings">destroy_orphaned_peerings</h2>

<pre><code>destroy_orphaned_peerings();</code></pre>

<p>Searches for network peerings in <b>Disconnected</b> state. Destroys a peering if its resource group does not exist anymore. Returns the result of deleting: 0 succeeded, 1 failed.</p>

<h2 id="no_cleanup_tag">no_cleanup_tag</h2>

<pre><code>no_cleanup_tag();</code></pre>

<p>Returns tag name that marks resource to be omitted during cleanup routine. Tag name can be defined by OpenQA setting `SDAF_NO_CLEANUP_TAG` with default value being &#39;sdaf_cleanup_ignore&#39;. This function ensures default value naming consistency across all modules, instead defining it with each &#39;get_var&#39; call.</p>


</body>

</html>


