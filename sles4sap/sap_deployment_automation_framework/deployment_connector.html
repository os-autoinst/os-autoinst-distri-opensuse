<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>lib/sles4sap/sap_deployment_automation_framework/deployment_connector.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel='stylesheet' href='../../style.css' />
</head>

<body>



<ul id="index"><li><a href="../../index.html"><i>&lt;= Back to file list</i></a></li>
  <li><a href="#SYNOPSIS">SYNOPSIS</a>
    <ul>
      <li><a href="#check_ssh_availability">check_ssh_availability</a></li>
      <li><a href="#get_deployer_ip">get_deployer_ip</a></li>
      <li><a href="#get_deployer_vm_name">get_deployer_vm_name</a></li>
      <li><a href="#get_parent_ids">get_parent_ids</a></li>
      <li><a href="#find_deployment_id">find_deployment_id</a></li>
      <li><a href="#get_deployer_resources">get_deployer_resources</a></li>
      <li><a href="#destroy_deployer_vm">destroy_deployer_vm</a></li>
    </ul>
  </li>
</ul><h1>lib/sles4sap/sap_deployment_automation_framework/deployment_connector.pm</h1>

<h1 id="SYNOPSIS">SYNOPSIS</h1>

<p>This library contains various functions that help finding and connecting openQA job to the correct deployment VM. Deployment VM is recognized from other VMs by being tagged with <b>deployment_id</b> tag. Deployment ID is an unique identifier which is an OpenQA job ID of a job that created this VM. In single machine test Deployment ID equals test ID. This is not always true in case of multi-machine jobs. Deployment ID might be an ID of the parent job which executed the deployment itself.</p>

<p><b>Example</b>: Job: 123456 - deployment module - created deployer VM tagged with &quot;deployment_id=123456&quot;, Job: 123457 (child of 123456) - some test module Deployment ID returned from both jobs: 123456 - because it matches with existing VM tagged with &quot;deployment_id=123456&quot;</p>

<h2 id="check_ssh_availability">check_ssh_availability</h2>

<pre><code>check_ssh_availability($deployer_ip_addr [, ssh_port=&gt;42 ,$wait_started=&gt;&#39;true&#39;, wait_timeout=&gt;&#39;42&#39;]);</code></pre>

<p>Checks if deployer VM is running and listening on ssh port. Returns found state. Optionally function can wait till VM reaches requested state until timeout. Function dies only with internal errors, VM status should be evaluated and handled by caller.</p>

<p><b>deployer_ip_addr</b>: Deployer VM IP address</p>

<p><b>wait_started</b>: Probe SSH port in loop untill it is available or <b>wait_timeoout</b> is reached.</p>

<p><b>wait_timeout</b>: Time in sec to stop probing SSH port.</p>

<p><b>ssh_port</b>: Specify custom SSH port number. Default: 22</p>

<h2 id="get_deployer_ip">get_deployer_ip</h2>

<pre><code>get_deployer_ip(deployer_resource_group=&gt;$deployer_resource_group, deployer_vm_name=&gt;$deployer_vm_name);</code></pre>

<p>Returns first public IP of deployer VM that is reachable and can be used for SDAF deployment connection.</p>

<p><b>deployer_resource_group</b>: Deployer resource group. Default: get_required_var(&#39;SDAF_DEPLOYER_RESOURCE_GROUP&#39;)</p>

<p><b>deployer_vm_name</b>: Deployer VM resource name</p>

<h2 id="get_deployer_vm_name">get_deployer_vm_name</h2>

<pre><code>get_deployer_vm_name(deployer_resource_group=&gt;$deployer_resource_group, deployment_id=&gt;&#39;123456&#39;);</code></pre>

<p>Returns deployer VM name which is tagged with <b>deployment_id</b> specified in parameter. This means that the VM was used to deploy the infrastructure under this ID and contains whole SDAF setup. Function returns VM name or undef if no VM was found. Function dies if there is more than one VM found, because two VM&#39;s must not have same ID.</p>

<p><b>deployer_resource_group</b>: Deployer resource group. Default: get_required_var(&#39;SDAF_DEPLOYER_RESOURCE_GROUP&#39;)</p>

<p><b>deployment_id</b>: Deployment ID</p>

<h2 id="get_parent_ids">get_parent_ids</h2>

<pre><code>get_parent_ids();</code></pre>

<p>Returns <b>ARRAYREF</b> of all parent job IDs acquired from current job data.</p>

<h2 id="find_deployment_id">find_deployment_id</h2>

<pre><code>find_deployment_id(deployer_resource_group=&gt;$deployer_resource_group);</code></pre>

<p>Finds deployment ID for currently running test. Deployment ID is ID of an OpenQA test which created deployer VM. In case of multi-machine test this can be either parent test ID or current job id as well. This function collects all OpenQA job IDs related to current test run and checks if any of them match an existing deployer VM tagged with this ID.</p>

<p><b>Example</b>: Job: 123456 - deployment module - created deployer VM tagged with &quot;deployment_id=123456&quot;, Job: 123457 (child of 123456) - some test module Deployment ID returned from both jobs: 123456 - because it matches with existing VM tagged with &quot;deployment_id=123456&quot;</p>

<p><b>deployer_resource_group</b>: Deployer resource group. Default: get_required_var(&#39;SDAF_DEPLOYER_RESOURCE_GROUP&#39;)</p>

<h2 id="get_deployer_resources">get_deployer_resources</h2>

<pre><code>get_deployer_resources(deployer_resource_group=&gt;$deployer_resource_group [, deployment_id=&gt;&#39;123456&#39;, return_ids=1]);</code></pre>

<p>Returns ARRAYREF of all resources belonging to <b>deployer_resource_group</b> tagged with <b>deployment_id</b>.</p>

<p><b>deployer_resource_group</b>: Deployer resource group. Default: get_required_var(&#39;SDAF_DEPLOYER_RESOURCE_GROUP&#39;)</p>

<p><b>deployment_id</b>: Deployment ID</p>

<p><b>return_value</b>: Control the content of the returned array. It can either return array of resource IDs or resource names. Values allowed: id, name Default: name</p>

<h2 id="destroy_deployer_vm">destroy_deployer_vm</h2>

<pre><code>destroy_deployer_vm([timeout=&gt;900]);</code></pre>

<p>Collects resource id of all resources belonging to the deployer VM and deletes them. Cleanup deployer VM resources only, <b>deployer resource group itself will stay intact</b>.</p>

<p><b>timeout</b>: Timeout for destroy command. Default: 800</p>


</body>

</html>


