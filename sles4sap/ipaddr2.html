<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>lib/sles4sap/ipaddr2.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel='stylesheet' href='../style.css' />
</head>

<body>



<ul id="index"><li><a href="../index.html"><i>&lt;= Back to file list</i></a></li>
  <li><a href="#SYNOPSIS">SYNOPSIS</a>
    <ul>
      <li><a href="#ipaddr2_azure_resource_group">ipaddr2_azure_resource_group</a></li>
      <li><a href="#ipaddr2_azure_storage_account">ipaddr2_azure_storage_account</a></li>
      <li><a href="#ipaddr2_azure_deployment">ipaddr2_azure_deployment</a></li>
      <li><a href="#ipaddr2_bastion_pubip">ipaddr2_bastion_pubip</a></li>
      <li><a href="#ipaddr2_bastion_ssh_addr">ipaddr2_bastion_ssh_addr</a></li>
      <li><a href="#ipaddr2_bastion_key_accept">ipaddr2_bastion_key_accept</a></li>
      <li><a href="#ipaddr2_deployment_sanity">ipaddr2_deployment_sanity</a></li>
      <li><a href="#ipaddr2_os_sanity">ipaddr2_os_sanity</a></li>
      <li><a href="#ipaddr2_os_connectivity_sanity">ipaddr2_os_connectivity_sanity</a></li>
      <li><a href="#ipaddr2_ssh_assert_script_run_bastion">ipaddr2_ssh_assert_script_run_bastion</a></li>
      <li><a href="#ipaddr2_deployment_logs">ipaddr2_deployment_logs</a></li>
      <li><a href="#ipaddr2_destroy">ipaddr2_destroy</a></li>
      <li><a href="#ipaddr2_get_internal_vm_name">ipaddr2_get_internal_vm_name</a></li>
      <li><a href="#ipaddr2_get_internal_vm_private_ip">ipaddr2_get_internal_vm_private_ip</a></li>
    </ul>
  </li>
</ul><h1>lib/sles4sap/ipaddr2.pm</h1>

<h1 id="SYNOPSIS">SYNOPSIS</h1>

<p>Library to manage ipaddr2 tests</p>

<h2 id="ipaddr2_azure_resource_group">ipaddr2_azure_resource_group</h2>

<pre><code>my $rg = ipaddr2_azure_resource_group();</code></pre>

<p>Get the Azure resource group name for this test</p>

<h2 id="ipaddr2_azure_storage_account">ipaddr2_azure_storage_account</h2>

<pre><code>my $storage account = ipaddr2_azure_storage_account();</code></pre>

<p>Get a unique storage account name. Not including the jobId result in error like: The storage account named ip2tstorageaccount already exists under the subscription</p>

<h2 id="ipaddr2_azure_deployment">ipaddr2_azure_deployment</h2>

<pre><code>my $rg = ipaddr2_azure_deployment();</code></pre>

<p>Create a deployment in Azure designed for this specific test.</p>

<p>1. Create a resource group to contain all 2. Create a vnet and subnet in it 3. Create one Public IP 4. Create 2 VM to run the cluster, both running a webserver and that are behind the LB 5. Create 1 additional VM that get 6. Create a Load Balancer with 2 VM in backend and with an IP as frontend</p>

<dl>

<dt id="region---existing-resource-group"><b>region</b> - existing resource group</dt>
<dd>

</dd>
<dt id="os---existing-Load-balancer-NAME"><b>os</b> - existing Load balancer NAME</dt>
<dd>

</dd>
<dt id="diagnostic---enable-diagnostic-features-if-1"><b>diagnostic</b> - enable diagnostic features if 1</dt>
<dd>

</dd>
</dl>

<h2 id="ipaddr2_bastion_pubip">ipaddr2_bastion_pubip</h2>

<pre><code>my $bastion_ip = ipaddr2_bastion_pubip();</code></pre>

<p>Get the only public IP in the deployment associated to the VM used as bastion.</p>

<h2 id="ipaddr2_bastion_ssh_addr">ipaddr2_bastion_ssh_addr</h2>

<pre><code>script_run(join(&#39; &#39;, &#39;ssh&#39;, ipaddr2_bastion_ssh_addr(), &#39;whoami&#39;);</code></pre>

<p>Help to create ssh command that target the only VM in the deployment that has public IP.</p>

<dl>

<dt id="bastion_ip---Public-IP-address-of-the-bastion.-Calculated-if-not-provided"><b>bastion_ip</b> - Public IP address of the bastion. Calculated if not provided.</dt>
<dd>

</dd>
</dl>

<h2 id="ipaddr2_bastion_key_accept">ipaddr2_bastion_key_accept</h2>

<pre><code>ipaddr2_bastion_key_accept()</code></pre>

<p>For the worker to accept the ssh key of the bastion</p>

<dl>

<dt id="bastion_ip---Public-IP-address-of-the-bastion.-Calculated-if-not-provided1"><b>bastion_ip</b> - Public IP address of the bastion. Calculated if not provided.</dt>
<dd>

</dd>
</dl>

<h2 id="ipaddr2_deployment_sanity">ipaddr2_deployment_sanity</h2>

<pre><code>ipaddr2_deployment_sanity()</code></pre>

<p>Run some checks on the existing deployment using the az command line. die in case of failure</p>

<h2 id="ipaddr2_os_sanity">ipaddr2_os_sanity</h2>

<pre><code>ipaddr2_os_sanity()</code></pre>

<p>Run some OS level checks on the various VMs composing the deployment. die in case of failure</p>

<dl>

<dt id="bastion_ip---Public-IP-address-of-the-bastion.-Calculated-if-not-provided.-managed-as-argument-not-to-have-to-call-ipaddr2_bastion_pubip-many-time-so-not-to-have-to-query-az-each-time"><b>bastion_ip</b> - Public IP address of the bastion. Calculated if not provided. managed as argument not to have to call ipaddr2_bastion_pubip many time, so not to have to query az each time</dt>
<dd>

</dd>
</dl>

<h2 id="ipaddr2_os_connectivity_sanity">ipaddr2_os_connectivity_sanity</h2>

<pre><code>ipaddr2_os_connectivity_sanity()</code></pre>

<p>Run some OS level checks about internal connectivity. die in case of failure</p>

<p>- bastion has to be able to ping the internal VM using the internal private IP - bastion has to be able to ping the internal VM using the internal VM hostname</p>

<dl>

<dt id="bastion_ip---Public-IP-address-of-the-bastion.-Calculated-if-not-provided.-managed-as-argument-not-to-have-to-call-ipaddr2_bastion_pubip-many-time-so-not-to-have-to-query-az-each-time1"><b>bastion_ip</b> - Public IP address of the bastion. Calculated if not provided. managed as argument not to have to call ipaddr2_bastion_pubip many time, so not to have to query az each time</dt>
<dd>

</dd>
</dl>

<h2 id="ipaddr2_ssh_assert_script_run_bastion">ipaddr2_ssh_assert_script_run_bastion</h2>

<pre><code>ipaddr2_ssh_assert_script_run_bastion(
    bastion_ip =&gt; &#39;1.2.3.4&#39;,
    cmd =&gt; &#39;whoami&#39;);</code></pre>

<p>run a command on the bastion using assert_script_run</p>

<dl>

<dt id="bastion_ip---Public-IP-address-of-the-bastion.-Calculated-if-not-provided.-managed-as-argument-not-to-have-to-call-ipaddr2_bastion_pubip-many-time-so-not-to-have-to-query-az-each-time2"><b>bastion_ip</b> - Public IP address of the bastion. Calculated if not provided. managed as argument not to have to call ipaddr2_bastion_pubip many time, so not to have to query az each time</dt>
<dd>

</dd>
<dt id="cmd---command-to-run-there"><b>cmd</b> - command to run there</dt>
<dd>

</dd>
</dl>

<h2 id="ipaddr2_deployment_logs">ipaddr2_deployment_logs</h2>

<pre><code>ipaddr2_deployment_logs()</code></pre>

<p>Collect logs from the cloud infrastructure</p>

<h2 id="ipaddr2_destroy">ipaddr2_destroy</h2>

<pre><code>ipaddr2_destroy();</code></pre>

<p>Destroy the deployment by deleting the resource group</p>

<h2 id="ipaddr2_get_internal_vm_name">ipaddr2_get_internal_vm_name</h2>

<pre><code>my $vm_name = ipaddr2_get_internal_vm_name(42);</code></pre>

<p>compose and return a string for the vm name</p>

<h2 id="ipaddr2_get_internal_vm_private_ip">ipaddr2_get_internal_vm_private_ip</h2>

<pre><code>my $private_ip = ipaddr2_get_internal_vm_private_ip(42);</code></pre>

<p>compose and return a string representing the VM private IP</p>


</body>

</html>


