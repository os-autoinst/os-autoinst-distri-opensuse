<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>lib/publiccloud/azure.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel='stylesheet' href='../style.css' />
</head>

<body>



<ul id="index"><li><a href="../index.html"><i>&lt;= Back to file list</i></a></li>
  <li>
    <ul>
      <li><a href="#az_arch-Provides-architecture-tag-x64-or-Arm64-compatible-with-Azure-syntax-based-on-ARCH-job-settings">az_arch Provides architecture tag x64 or Arm64 compatible with Azure syntax, based on &#39;*ARCH&#39; job settings</a></li>
      <li><a href="#az_sku-Centralized-sku-definition-and-default-value-based-on-PUBLIC_CLOUD_AZURE_SKU">az_sku Centralized sku definition and default value, based on PUBLIC_CLOUD_AZURE_SKU</a></li>
      <li><a href="#decode_azure_json">decode_azure_json</a></li>
      <li><a href="#resource_group_exist">resource_group_exist</a></li>
      <li><a href="#img_blob_exists">img_blob_exists</a></li>
      <li><a href="#get_image_version">get_image_version</a></li>
      <li><a href="#find_img">find_img</a></li>
      <li><a href="#generate_img_version-Build-the-image-Version-for-upload-to-the-Compute-Gallery.-The-expected-format-is-X.Y.Z.-We-assemble-the-img-version-by-the-PUBLIC_CLOUD_BUILD-Format:-X.Y-and-the-digits-of-PUBLIC_CLOUD_KIWI_BUILD-formatted-as-integer">generate_img_version Build the image Version for upload to the Compute Gallery. The expected format is &#39;X.Y.Z&#39;. We assemble the img version by the PUBLIC_CLOUD_BUILD (Format: &#39;X.Y&#39;) and the digits of PUBLIC_CLOUD_KIWI_BUILD, formatted as integer</a></li>
      <li><a href="#generate_azure_image_definition">generate_azure_image_definition</a></li>
      <li><a href="#get_image_definition-Check-if-the-given-image-definition-identified-by-the-tuple-publisher-offer-and-sku-is-present-in-the-given-image-gallery-returns-the-name-of-the-found-image-definition-or-undef-if-not-found">get_image_definition Check if the given image definition, identified by the tuple (publisher, offer and sku) is present in the given image gallery returns the name of the found image definition or undef if not found</a></li>
      <li><a href="#get_blob_name">get_blob_name</a></li>
      <li><a href="#get_blob_uri">get_blob_uri</a></li>
      <li><a href="#upload_img">upload_img</a></li>
      <li><a href="#my-parsed_id-self-parse_instance_id-instance-say-parsed_id--vm_name-say-parsed_id--resource_group">my $parsed_id = $self-&gt;parse_instance_id($instance); say $parsed_id-&gt;{vm_name}; say $parsed_id-&gt;{resource_group};</a></li>
      <li><a href="#cleanup-This-method-is-called-called-after-each-test-on-failure-or-success-to-revoke-the-credentials">cleanup This method is called called after each test on failure or success to revoke the credentials</a></li>
    </ul>
  </li>
</ul><h1>lib/publiccloud/azure.pm</h1>

<h2 id="az_arch-Provides-architecture-tag-x64-or-Arm64-compatible-with-Azure-syntax-based-on-ARCH-job-settings">az_arch Provides architecture tag x64 or Arm64 compatible with Azure syntax, based on &#39;*ARCH&#39; job settings</h2>

<h2 id="az_sku-Centralized-sku-definition-and-default-value-based-on-PUBLIC_CLOUD_AZURE_SKU">az_sku Centralized sku definition and default value, based on PUBLIC_CLOUD_AZURE_SKU</h2>

<pre><code>Call: az_sku(&lt;default&gt;);
    when PUBLIC_CLOUD_AZURE_SKU undefined, the default from input is used:
    when &lt;default&gt; is undefined too, hardcoded string used; i.e. az_sku(), default = &#39;gen2&#39;; </code></pre>

<h2 id="decode_azure_json">decode_azure_json</h2>

<pre><code>my $json_obj = decode_azure_json($str);</code></pre>

<p>Helper function to decode json string, retrieved from <code>az</code>, into a json object. Due to https://github.com/Azure/azure-cli/issues/9903 we need to strip all color codes from that string first.</p>

<h2 id="resource_group_exist">resource_group_exist</h2>

<pre><code>$self-&gt;resource_group_exist();</code></pre>

<p>Checks if the Azure resource group exists and returns boolean</p>

<h2 id="img_blob_exists">img_blob_exists</h2>

<p>Finds the image blob in Azure</p>

<pre><code>* Requires image name parameter, e.g. &#39;SLES15-SP5-BYOS.aarch64-1.0.0-Azure-Build1.68.xz&#39;
* Returns 0 if the image blob  has not been found or 1 if the image blob has ben found.</code></pre>

<h2 id="get_image_version">get_image_version</h2>

<p>Finds the image version in Azure</p>

<p>Returns the image version id or undef if not found.</p>

<p>Return example: &#39;/subscriptions/SMTHNG-XYZ-123/resourceGroups/openqa-upload/providers/Microsoft.Compute/galleries/test_image_gallery/images/SLE-15-SP5-AZURE-BYOS-X64-GEN2/versions/1.64.100&#39;</p>

<h2 id="find_img">find_img</h2>

<pre><code>my $image_id = $self-&gt;find_img($name);</code></pre>

<p>Requires the image name: * The variable may also be URL and the name will be extracted from it. * The name is then used to search for the image blob.</p>

<p>Does the following steps: 1) Checks if the image blob exists 2) Checks if the image version exists</p>

<pre><code>* If the image definition does not exist the image version does not either.</code></pre>

<p>Return example: &#39;/subscriptions/SMTHNG-XYZ-123/resourceGroups/openqa-upload/providers/Microsoft.Compute/galleries/test_image_gallery/images/SLE-15-SP5-AZURE-BYOS-X64-GEN2/versions/1.64.100&#39; If either blob or the image version were not found then the default empty list or undef in the scalar context is returned.</p>

<h2 id="generate_img_version-Build-the-image-Version-for-upload-to-the-Compute-Gallery.-The-expected-format-is-X.Y.Z.-We-assemble-the-img-version-by-the-PUBLIC_CLOUD_BUILD-Format:-X.Y-and-the-digits-of-PUBLIC_CLOUD_KIWI_BUILD-formatted-as-integer">generate_img_version Build the image Version for upload to the Compute Gallery. The expected format is &#39;X.Y.Z&#39;. We assemble the img version by the PUBLIC_CLOUD_BUILD (Format: &#39;X.Y&#39;) and the digits of PUBLIC_CLOUD_KIWI_BUILD, formatted as integer</h2>

<h2 id="generate_azure_image_definition">generate_azure_image_definition</h2>

<pre><code>my $definition = $self-&gt;generate_azure_image_definition();</code></pre>

<p>Generates the Azure Image name from the job settings. If PUBLIC_CLOUD_AZURE_IMAGE_DEFINITION defined, its content is returned; otherwise, image definition name based on distri, version, flavor and SKU returned.</p>

<p>Note: Image definitions shall be distinct names and can only serve one architecture!</p>

<p>Example: &#39;SLE-MICRO-5.4-BYOS-AZURE-X86_64-GEN2&#39;</p>

<pre><code>B&lt;return&gt; a string with the image full name distri-version-flavor-arch-sku</code></pre>

<h2 id="get_image_definition-Check-if-the-given-image-definition-identified-by-the-tuple-publisher-offer-and-sku-is-present-in-the-given-image-gallery-returns-the-name-of-the-found-image-definition-or-undef-if-not-found">get_image_definition Check if the given image definition, identified by the tuple (publisher, offer and sku) is present in the given image gallery returns the name of the found image definition or undef if not found</h2>

<h2 id="get_blob_name">get_blob_name</h2>

<pre><code>Calculate the image (blob) name
from the file name used in SUSE download server (usually PUBLIC_CLOUD_IMAGE_LOCATION)

B&lt;return&gt; a string with the image name</code></pre>

<dl>

<dt id="FILE---filename-usually-extracted-from-PUBLIC_CLOUD_IMAGE_LOCATION"><b>FILE</b> - filename, usually extracted from PUBLIC_CLOUD_IMAGE_LOCATION</dt>
<dd>

</dd>
</dl>

<h2 id="get_blob_uri">get_blob_uri</h2>

<pre><code>Calculate the image URI in the Azure Blob Server
from the file name used in SUSE download server (usually PUBLIC_CLOUD_IMAGE_LOCATION)

PUBLIC_CLOUD_STORAGE_ACCOUNT setting is used to compose the url

B&lt;return&gt; a string with the image uri on the blob server</code></pre>

<dl>

<dt id="FILE---filename-usually-extracted-from-PUBLIC_CLOUD_IMAGE_LOCATION1"><b>FILE</b> - filename, usually extracted from PUBLIC_CLOUD_IMAGE_LOCATION</dt>
<dd>

</dd>
</dl>

<h2 id="upload_img">upload_img</h2>

<p>1) Create resources 2) Upload the image blob 3) Create image definition 4) Create new image version for that definition. Use the link to the uploaded blob to create this version</p>

<h2 id="my-parsed_id-self-parse_instance_id-instance-say-parsed_id--vm_name-say-parsed_id--resource_group">my $parsed_id = $self-&gt;parse_instance_id($instance); say $parsed_id-&gt;{vm_name}; say $parsed_id-&gt;{resource_group};</h2>

<p>Extract resource group and vm name from full instance id which looks like <code>/subscriptions/c011786b-59d7-4817-880c-7cd8a6ca4b19/resourceGroups/openqa-suse-de-1ec3f5a05b7c0712/providers/Microsoft.Compute/virtualMachines/openqa-suse-de-1ec3f5a05b7c0712</code></p>

<h2 id="cleanup-This-method-is-called-called-after-each-test-on-failure-or-success-to-revoke-the-credentials">cleanup This method is called called after each test on failure or success to revoke the credentials</h2>


</body>

</html>


