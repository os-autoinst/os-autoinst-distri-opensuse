---
name: basic_cluster_node
description: >
  Cluster Test. Schedule for alpha/beta/ctdb (2 nodes cluster) and delta/gamma (3 nodes cluster).

  Some settings are required in the job group or test suite for this schedule to work.

  The other settings required in the job group are.

  CLUSTER_NAME must be defined for all jobs as a string.
  HA_CLUSTER_INIT must be defined to a non false value in the parent job
  HA_CLUSTER_JOIN must be defined for the rest of the jobs, and it must contain the
  hostname of the parent job (the job where HA_CLUSTER_SETUP is defined to init)
  HOSTNAME must be defined to different hostnames for each node.
  All jobs with the exception of the parent job must include a PARALLEL_WITH setting
  referencing the parent job.
  NICTYPE and WORKER_CLASS must be set to 'tap' in the job group directly in qemu based jobs.
  TWO_NODES must be set to 'no' for every cluster with more than '2' nodes.
  And of course, YAML_SCHEDULE must point to this file.

  Below are the optional settings.

  CTDB_TEST_ROLE can be defined as 'server' for testing CTDB.
  HA_CLUSTER_DRBD can be defined for enabling DRBD test.
  HA_REMOVE_NODE can be defined for testing a node removal.
  USE_DISKLESS_SBD can be defined for making a cluster without sbd device.
  USE_SYSRQ_FENCING can be defined for fencing through sysrq instead of 'crm node fence' command.

vars:
  # Boot qcow2 image generated by create_hdd_ha_textmode
  BOOT_HDD_IMAGE: '1'
  DESKTOP: 'textmode'
  HA_CLUSTER: '1'
  HDDMODEL: 'scsi-hd'
  HDD_SCC_REGISTERED: '1'
  # Disable qemu snapshots to avoid unexpected fences in HA tests
  QEMU_DISABLE_SNAPSHOTS: '1'
  TIMEOUT_SCALE: '2'
  # LVM locking daemon used since SLE 15
  USE_LVMLOCKD: '1'
  USE_SUPPORT_SERVER: '1'
  VIRTIO_CONSOLE: '0'
  # Below have to be entered in the OpenQA UI because it doesn't read this YAML
  # HDD_1: SLE-%VERSION%-%ARCH%-Build%BUILD%-HA-BV.qcow2
schedule:
  - boot/boot_to_desktop
  - ha/wait_barriers
  - console/system_prepare
  - console/consoletest_setup
  - console/check_os_release
  - console/hostname
  - ha/ha_sle15_workarounds
  - ha/firewall_disable
  - ha/iscsi_client
  - ha/watchdog
  - '{{cluster_setup}}'
  - ha/check_hawk
  - ha/dlm
  - ha/clvmd_lvmlockd
  - ha/cluster_md
  - ha/vg
  - ha/filesystem
  - '{{drbd}}'
  - '{{ctdb}}'
  - ha/fencing
  - '{{boot_to_desktop_node01}}'
  - ha/check_after_reboot
  - '{{remove_node}}'
  - ha/check_logs
conditional_schedule:
  cluster_setup:
    HA_CLUSTER_SETUP:
      init:
        - ha/ha_cluster_init
      join:
        - ha/ha_cluster_join
  drbd:
    HA_CLUSTER_DRBD:
      1:
        - ha/drbd_passive
        - ha/filesystem
  ctdb:
    CTDB_TEST_ROLE:
      server:
        - ha/ctdb
  boot_to_desktop_node01:
    HA_CLUSTER_SETUP:
      init:
        - boot/boot_to_desktop
  remove_node:
    HA_REMOVE_NODE:
      1:
        - ha/remove_node
