<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>lib/bootloader_setup.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel='stylesheet' href='./style.css' />
</head>

<body>



<ul id="index"><li><a href="./index.html"><i>&lt;= Back to file list</i></a></li>
  <li>
    <ul>
      <li><a href="#add_custom_grub_entries">add_custom_grub_entries</a></li>
      <li><a href="#boot_grub_item">boot_grub_item</a></li>
      <li><a href="#modify_grub_parameters_grub2_bls">modify_grub_parameters_grub2_bls</a></li>
      <li><a href="#get_linuxrc_boot_params">get_linuxrc_boot_params</a></li>
      <li><a href="#grep_grub_settings">grep_grub_settings</a></li>
      <li><a href="#grep_grub_cmdline_settings">grep_grub_cmdline_settings</a></li>
      <li><a href="#change_grub_config">change_grub_config</a></li>
      <li><a href="#add_grub_cmdline_settings">add_grub_cmdline_settings</a></li>
      <li><a href="#add_grub_xen_cmdline_settings">add_grub_xen_cmdline_settings</a></li>
      <li><a href="#add_grub_xen_replace_cmdline_settings">add_grub_xen_replace_cmdline_settings</a></li>
      <li><a href="#replace_grub_cmdline_settings">replace_grub_cmdline_settings</a></li>
      <li><a href="#replace_grub_xen_cmdline_settings">replace_grub_xen_cmdline_settings</a></li>
      <li><a href="#remove_grub_cmdline_settings">remove_grub_cmdline_settings</a></li>
      <li><a href="#remove_grub_xen_cmdline_settings">remove_grub_xen_cmdline_settings</a></li>
      <li><a href="#grub_mkconfig">grub_mkconfig</a></li>
      <li><a href="#parse_bootparams_in_serial">parse_bootparams_in_serial</a></li>
      <li><a href="#compare_bootparams">compare_bootparams</a></li>
      <li><a href="#create_encrypted_part">create_encrypted_part</a></li>
      <li><a href="#mimic_user_to_import">mimic_user_to_import</a></li>
      <li><a href="#prepare_disks">prepare_disks</a></li>
      <li><a href="#sync_time">sync_time</a></li>
    </ul>
  </li>
</ul><h1>lib/bootloader_setup.pm</h1>

<h2 id="add_custom_grub_entries">add_custom_grub_entries</h2>

<p>Add custom grub entries with extra kernel parameters. It adds 3rd line with default options + 4th line with advanced options. Extra kernel parameters are taken in <code>GRUB_PARAM</code> variable (a semicolon-separated list).</p>

<p>e.g. grub entries before:</p>

<pre><code>* SLES 15
* Advanced options for SLES 15
* Start bootloader from a read-only snapshot</code></pre>

<p>grub entries with <code>GRUB_PARAM=&#39;ima_policy=tcb&#39;</code> and calling add_custom_grub_entries:</p>

<pre><code>* SLES 15
* Advanced options for SLES 15
* SLES 15 (ima_policy=tcb)
* Advanced options for SLES 15 (ima_policy=tcb)
* Start bootloader from a read-only snapshot</code></pre>

<p>And of course the new entries have <code>ima_policy=tcb</code> added to kernel parameters.</p>

<h2 id="boot_grub_item">boot_grub_item</h2>

<pre><code>boot_grub_item([ $menu1, [ $menu2 ] ]);</code></pre>

<p>Choose custom boot menu entry in grub. <code>$menu1</code> defines which entry to choose in first boot menu, optional <code>$menu2</code> defines which entry to choose in second boot menu (makes sense only when <code>$menu1</code> selects &quot;Advanced options&quot;, otherwise it&#39;s ignored).</p>

<p>Default value is <code>$menu1 = 3, $menu2 = 1</code>, which boots kernel with extra parameters (generated by add_custom_grub_entries()) or 3rd option whatever it is other OS (given that 1st and 2nd grub options are for the default kernel):</p>

<p>Examples:</p>

<p>Boot kernel with extra parameters (generated with add_custom_grub_entries()) or 3rd option whatever it is other OS:</p>

<pre><code>boot_grub_item();
boot_grub_item(3);</code></pre>

<p>Boot the default kernel:</p>

<pre><code>boot_grub_item(1);</code></pre>

<p>Boot the default kernel recovery mode (selected in the &quot;Advanced options ...&quot;):</p>

<pre><code>boot_grub_item(2, 2);</code></pre>

<h2 id="modify_grub_parameters_grub2_bls">modify_grub_parameters_grub2_bls</h2>

<pre><code>modify_grub_parameters_grub2_bls()</code></pre>

<p>For grub2-bls bootloader, update /etc/kernel/cmdline contents by appending the desired custom kernel parameters taken in <code>GRUB_ARGS</code>, and call sdbootutil to update the grub entry for the currently running kernel, which persists through reboots.</p>

<h2 id="get_linuxrc_boot_params">get_linuxrc_boot_params</h2>

<pre><code>get_linuxrc_boot_params();</code></pre>

<p>Returns array of strings <code>@params</code> with linurc boot options to enable logging to the serial console, enable core dumps and set debug level for logging.</p>

<h2 id="grep_grub_settings">grep_grub_settings</h2>

<pre><code>grep_grub_settings($pattern)</code></pre>

<p>Search for <code>$pattern</code> in /etc/default/grub, return 1 if found.</p>

<h2 id="grep_grub_cmdline_settings">grep_grub_cmdline_settings</h2>

<pre><code>grep_grub_cmdline_settings($pattern [, $search])</code></pre>

<p>Search for <code>$pattern</code> in grub cmdline variable (usually GRUB_CMDLINE_LINUX_DEFAULT) in /etc/default/grub, return 1 if found.</p>

<h2 id="change_grub_config">change_grub_config</h2>

<pre><code>change_grub_config($old, $new [, $search ] [, $modifiers ], [, $update_grub ]);</code></pre>

<p>Replace <code>$old</code> with <code>$new</code> in /etc/default/grub, using sed. <code>$new</code>, default empty string <code>$search</code> meant to be for changing only particular line for sed, <code>$modifiers</code> for sed replacement, e.g. &quot;g&quot;. <code>$update_grub</code> if set, regenerate /boot/grub2/grub.cfg with grub2-mkconfig and upload configuration.</p>

<h2 id="add_grub_cmdline_settings">add_grub_cmdline_settings</h2>

<pre><code>add_grub_cmdline_settings($add [, update_grub =&gt; $update_grub] [, search =&gt; $search]);</code></pre>

<p>Add <code>$add</code> into /etc/default/grub, using sed. <code>$update_grub</code> if set, regenerate /boot/grub2/grub.cfg with grub2-mkconfig and upload configuration. <code>$search</code> if set, bypass default grub cmdline variable.</p>

<h2 id="add_grub_xen_cmdline_settings">add_grub_xen_cmdline_settings</h2>

<pre><code>add_grub_xen_cmdline_settings($add [, $update_grub ]);</code></pre>

<p>Add <code>$add</code> into /etc/default/grub, using sed. <code>$update_grub</code> if set, regenerate /boot/grub2/grub.cfg with grub2-mkconfig and upload configuration.</p>

<h2 id="add_grub_xen_replace_cmdline_settings">add_grub_xen_replace_cmdline_settings</h2>

<pre><code>add_grub_xen_replace_cmdline_settings($add [, $update_grub ]);</code></pre>

<p>Add <code>$add</code> into /etc/default/grub, using sed. <code>$update_grub</code> if set, regenerate /boot/grub2/grub.cfg with grub2-mkconfig and upload configuration.</p>

<h2 id="replace_grub_cmdline_settings">replace_grub_cmdline_settings</h2>

<pre><code>replace_grub_cmdline_settings($old, $new [, update_grub =&gt; $update_grub] [, search =&gt; $search]);</code></pre>

<p>Replace <code>$old</code> with <code>$new</code> in /etc/default/grub, using sed. <code>$update_grub</code> if set, regenerate /boot/grub2/grub.cfg with grub2-mkconfig and upload configuration. <code>$search</code> if set, bypass default grub cmdline variable.</p>

<h2 id="replace_grub_xen_cmdline_settings">replace_grub_xen_cmdline_settings</h2>

<pre><code>replace_grub_xen_cmdline_settings($old, $new [, $update_grub ]);</code></pre>

<p>Replace <code>$old</code> with <code>$new</code> in /etc/default/grub, using sed. <code>$update_grub</code> if set, regenerate /boot/grub2/grub.cfg with grub2-mkconfig and upload configuration.</p>

<h2 id="remove_grub_cmdline_settings">remove_grub_cmdline_settings</h2>

<pre><code>remove_grub_cmdline_settings($remove [, $search]);</code></pre>

<p>Remove <code>$remove</code> from /etc/default/grub (using sed) and regenerate /boot/grub2/grub.cfg. Search line <code>$search</code> from /etc/default/grub (use for sed).</p>

<h2 id="remove_grub_xen_cmdline_settings">remove_grub_xen_cmdline_settings</h2>

<pre><code>remove_grub_xen_cmdline_settings($remove);</code></pre>

<p>Remove <code>$remove</code> from /etc/default/grub (using sed) and regenerate /boot/grub2/grub.cfg.</p>

<h2 id="grub_mkconfig">grub_mkconfig</h2>

<pre><code>grub_mkconfig();
grub_mkconfig($config);</code></pre>

<p>Regenerate /boot/grub2/grub.cfg with grub2-mkconfig.</p>

<h2 id="parse_bootparams_in_serial">parse_bootparams_in_serial</h2>

<pre><code>parse_bootparams_in_serial();</code></pre>

<p>Parses serail output, searching for &#39;Command line&#39; parameters. Then converts the found parameters to an array of the values.</p>

<p>Returns the array of the boot parameters.</p>

<h2 id="compare_bootparams">compare_bootparams</h2>

<pre><code>compare_bootparams(\@array1, \@array2);</code></pre>

<p>Compares two arrays of bootparameters passed by array reference and logs the result to openQA using record_info.</p>

<p>Does not fail the test module but just highlights the result of the comparison.</p>

<h2 id="create_encrypted_part">create_encrypted_part</h2>

<pre><code>create_encrypted_part(disk =&gt; $disk, luks_type =&gt; $luks_type);</code></pre>

<p>Creates gpt partition table on a given disk and creates encrypted partition on it using default luks encryption or specific encryption if provided. It is useful to test encrypted partitions activation in the installer.</p>

<h2 id="mimic_user_to_import">mimic_user_to_import</h2>

<pre><code>mimic_user_to_import(disk =&gt; $disk, passwd =&gt; $passwd, shadow =&gt; $shadow);</code></pre>

<p>Creates /etc/passwd and /etc/shadow files to simluate existing users on the encrypted partition disk. Is expected to be used together with create_encrypted_part Can be used to test user import functionality not to chain jobs. Method accepts <code>disk</code> to define the device to work with, <code>passwd</code> and <code>shadow</code> store content of the /etc/passwd and /etc/shadow files accordingly.</p>

<h2 id="prepare_disks">prepare_disks</h2>

<pre><code>prepare_disks</code></pre>

<p>Wipe existing disks and create encrypted partitions if needed for the test. Is handy for the bare metal setups and LPARs where we can have traces of previous installation.</p>

<h2 id="sync_time">sync_time</h2>

<pre><code>sync_time</code></pre>

<p>Sync system time, time offset can cause problems e.g. certificate is not yet valid</p>


</body>

</html>


