<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>lib/power_action_utils.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel='stylesheet' href='./style.css' />
</head>

<body>



<ul id="index"><li><a href="./index.html"><i>&lt;= Back to file list</i></a></li>
  <li><a href="#power_action_utils">power_action_utils</a>
    <ul>
      <li><a href="#prepare_system_shutdown">prepare_system_shutdown</a></li>
      <li><a href="#reboot_x11">reboot_x11</a></li>
      <li><a href="#poweroff_x11">poweroff_x11</a></li>
      <li><a href="#handle_livecd_reboot_failure">handle_livecd_reboot_failure</a></li>
      <li><a href="#power_action">power_action</a></li>
      <li><a href="#assert_shutdown_and_restore_system">assert_shutdown_and_restore_system</a></li>
      <li><a href="#assert_shutdown_with_soft_timeout">assert_shutdown_with_soft_timeout</a></li>
      <li><a href="#check_bsc1215132">check_bsc1215132</a></li>
    </ul>
  </li>
</ul><h1>lib/power_action_utils.pm</h1>

<h1 id="power_action_utils">power_action_utils</h1>

<p>The module provides base and helper functions for powering off or rebooting a machine under test.</p>

<h2 id="prepare_system_shutdown">prepare_system_shutdown</h2>

<pre><code>prepare_system_shutdown();</code></pre>

<p>Need to kill ssh connection with backends like ipmi, spvm, pvm_hmc, s390x.</p>

<p>For s390_zkvm or xen, assign console($vnc_console) with <code>disable_vnc_stalls</code> and assign console(&#39;svirt&#39;) with <code>stop_serial_grab</code>.</p>

<p>$vnc_console get required variable &#39;SVIRT_VNC_CONSOLE&#39; before assignment.</p>

<h2 id="reboot_x11">reboot_x11</h2>

<pre><code>reboot_x11();</code></pre>

<p>Reboot from a desktop session and handle authentication scenarios during shutdown.</p>

<p>Run <code>prepare_system_shutdown</code> if shutdown needs authentification.</p>

<h2 id="poweroff_x11">poweroff_x11</h2>

<p>Power off desktop.</p>

<p>Handle each desktop differently for kde, gnome, xfce, lxde, lxqt, enlightenment, awesome, mate, minimalx.</p>

<p>Work around issue with CD-ROM pop-up: bsc#1137230 and make sure that s390 SUT shutdown correctly.</p>

<h2 id="handle_livecd_reboot_failure">handle_livecd_reboot_failure</h2>

<pre><code>handle_livecd_reboot_failure();</code></pre>

<p>Handle a potential failure on a live CD related to boo#993885 that the reboot action from a desktop session does not work and we are stuck on the desktop.</p>

<h2 id="power_action">power_action</h2>

<pre><code>power_action($action [,observe =&gt; $observe] [,keepconsole =&gt; $keepconsole] [,textmode =&gt; $textmode]);</code></pre>

<p>Executes the selected power action (e.g. poweroff, reboot).</p>

<p>If <code>$observe</code> is set, the function expects that the specified <code>$action</code> was already executed by another actor and the function just makes sure the system shuts down, restarts etc. properly.</p>

<p><code>$keepconsole</code> prevents a console change, which we do by default to make sure that a system with a GUI desktop which was in text console at the time of <code>power_action</code> call, is switched to the expected console, that is &#39;root-console&#39; for textmode, &#39;x11&#39; otherwise. The actual execution happens in a shell for textmode or with GUI commands otherwise unless explicitly overridden by setting <code>$textmode</code> to either 0 or 1.</p>

<h2 id="assert_shutdown_and_restore_system">assert_shutdown_and_restore_system</h2>

<pre><code>assert_shutdown_and_restore_system($action, $shutdown_timeout);</code></pre>

<p>VNC connection to SUT (the &#39;sut&#39; console) is terminated on Xen via svirt backend and we have to re-connect *after* the restart, otherwise we end up with stalled VNC connection. The tricky part is to know *when* the system is already booting.</p>

<p>Default $action is reboot, $shutdown_timeout is timeout for shutdown, default value is 60 seconds.</p>

<h2 id="assert_shutdown_with_soft_timeout">assert_shutdown_with_soft_timeout</h2>

<pre><code>assert_shutdown_with_soft_timeout([$args]);

$args = {[timeout =&gt; $timeout] [,soft_timeout =&gt; $soft_timeout] [,bugref =&gt; $bugref] [,soft_failure_reason =&gt; $soft_failure_reason]}</code></pre>

<p>Extending assert_shutdown with a soft timeout. When <code>$args-</code>{soft_timeout}&gt; is reached, a soft failure is recorded with the message <code>$args-</code>{soft_failure_reason}&gt;.</p>

<p>After that, assert_shutdown continues until the (hard) timeout <code>$args-</code>{timeout}&gt; is hit.</p>

<p>This makes sense when a shutdown sporadically takes longer then it normally should take and the proper statistics of such cases should be gathered instead of just increasing a timeout.</p>

<p>If <code>$args-</code>{soft_timeout}&gt; is not specified, then the default assert_shutdown is executed.</p>

<p>Example:</p>

<pre><code>assert_shutdown_with_soft_timeout({timeout =&gt; 300, soft_timeout =&gt; 60, bugref =&gt; &#39;bsc#123456&#39;});</code></pre>

<h2 id="check_bsc1215132">check_bsc1215132</h2>

<pre><code>Validate dependencies which provides shutdown/poweroff/reboot commands.
Use this in the post_fail_hook to raise a softfail of the reported bug.</code></pre>


</body>

</html>


