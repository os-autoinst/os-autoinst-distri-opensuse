<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>lib/qesapdeployment.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel='stylesheet' href='./style.css' />
</head>

<body>



<ul id="index"><li><a href="./index.html"><i>&lt;= Back to file list</i></a></li>
  <li><a href="#NAME">NAME</a></li>
  <li><a href="#COPYRIGHT">COPYRIGHT</a></li>
  <li><a href="#AUTHORS">AUTHORS</a></li>
  <li><a href="#DESCRIPTION">DESCRIPTION</a>
    <ul>
      <li><a href="#Methods">Methods</a>
        <ul>
          <li><a href="#qesap_get_file_paths">qesap_get_file_paths</a></li>
          <li><a href="#qesap_create_folder_tree">qesap_create_folder_tree</a></li>
          <li><a href="#qesap_get_variables">qesap_get_variables</a></li>
          <li><a href="#qesap_create_ansible_section">qesap_create_ansible_section</a></li>
          <li><a href="#qesap_pip_install">qesap_pip_install</a></li>
          <li><a href="#qesap_upload_logs">qesap_upload_logs</a></li>
          <li><a href="#qesap_get_deployment_code">qesap_get_deployment_code</a></li>
          <li><a href="#qesap_yaml_replace">qesap_yaml_replace</a></li>
          <li><a href="#qesap_execute">qesap_execute</a></li>
          <li><a href="#qesap_get_inventory">qesap_get_inventory</a></li>
          <li><a href="#qesap_get_nodes_number">qesap_get_nodes_number</a></li>
          <li><a href="#qesap_get_terraform_dir">qesap_get_terraform_dir</a></li>
          <li><a href="#qesap_prepare_env">qesap_prepare_env</a></li>
          <li><a href="#qesap_ansible_cmd">qesap_ansible_cmd</a></li>
          <li><a href="#qesap_ansible_script_output">qesap_ansible_script_output</a></li>
          <li><a href="#qesap_create_aws_credentials">qesap_create_aws_credentials</a></li>
          <li><a href="#qesap_create_aws_config">qesap_create_aws_config</a></li>
          <li><a href="#qesap_remote_hana_public_ips">qesap_remote_hana_public_ips</a></li>
          <li><a href="#qesap_wait_for_ssh">qesap_wait_for_ssh</a></li>
          <li><a href="#qesap_cluster_log_cmds">qesap_cluster_log_cmds</a></li>
          <li><a href="#qesap_cluster_logs">qesap_cluster_logs</a></li>
          <li><a href="#qesap_az_get_vnet">qesap_az_get_vnet</a></li>
          <li><a href="#qesap_calculate_deployment_name">qesap_calculate_deployment_name</a></li>
          <li><a href="#qesap_az_get_resource_group">qesap_az_get_resource_group</a></li>
          <li><a href="#qesap_calculate_az_address_range">qesap_calculate_az_address_range</a></li>
          <li><a href="#qesap_az_vnet_peering">qesap_az_vnet_peering</a></li>
          <li><a href="#qesap_az_vnet_peering_delete">qesap_az_vnet_peering_delete</a></li>
          <li><a href="#qesap_az_get_peering_name">qesap_az_get_peering_name</a></li>
          <li><a href="#qesap_add_server_to_hosts">qesap_add_server_to_hosts</a></li>
          <li><a href="#qesap_import_instances">qesap_import_instances</a></li>
          <li><a href="#qesap_export_instances">qesap_export_instances</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#POD-ERRORS">POD ERRORS</a></li>
</ul><h1>lib/qesapdeployment.pm</h1>

<h1 id="NAME">NAME</h1>

<pre><code>qe-sap-deployment test lib</code></pre>

<h1 id="COPYRIGHT">COPYRIGHT</h1>

<pre><code>Copyright 2022 SUSE LLC
SPDX-License-Identifier: FSFAP</code></pre>

<h1 id="AUTHORS">AUTHORS</h1>

<pre><code>QE SAP &lt;qe-sap@suse.de&gt;</code></pre>

<h1 id="DESCRIPTION">DESCRIPTION</h1>

<pre><code>Package with common methods and default or constant  values for qe-sap-deployment</code></pre>

<h2 id="Methods">Methods</h2>

<h3 id="qesap_get_file_paths">qesap_get_file_paths</h3>

<pre><code>Returns a hash containing file paths for config files</code></pre>

<h3 id="qesap_create_folder_tree">qesap_create_folder_tree</h3>

<pre><code>Create all needed folders</code></pre>

<h3 id="qesap_get_variables">qesap_get_variables</h3>

<pre><code>Scans yaml config for &#39;%OPENQA_VARIABLE%&#39; placeholders and searches for values in OpenQA defined variables.
Returns hash with openqa variable key/value pairs.</code></pre>

<h3 id="qesap_create_ansible_section">qesap_create_ansible_section</h3>

<pre><code>Writes &quot;ansible&quot; section into yaml config file.
$args{ansible_section} defines section(key) name.
$args{section_content} defines content of names section.
    Example:
        @playbook_list = (&quot;pre-cluster.yaml&quot;, &quot;cluster_sbd_prep.yaml&quot;);
        qesap_create_ansible_section(ansible_section=&gt;&#39;create&#39;, section_content=&gt;\@playbook_list);</code></pre>

<h3 id="qesap_pip_install">qesap_pip_install</h3>

<pre><code>Install all Python requirements of the qe-sap-deployment in a dedicated virtual environment</code></pre>

<h3 id="qesap_upload_logs">qesap_upload_logs</h3>

<pre><code>qesap_upload_logs([failok=1])

Collect and upload logs present in @log_files.</code></pre>

<dl>

<dt id="FAILOK---used-as-failok-for-the-upload_logs.-continue-even-in-case-upload-fails"><b>FAILOK</b> - used as failok for the upload_logs. continue even in case upload fails</dt>
<dd>

</dd>
</dl>

<h3 id="qesap_get_deployment_code">qesap_get_deployment_code</h3>

<pre><code>Get the qe-sap-deployment code</code></pre>

<h3 id="qesap_yaml_replace">qesap_yaml_replace</h3>

<pre><code>Replaces yaml config file variables with parameters defined by OpenQA testode, yaml template or yaml schedule.
Openqa variables need to be added as a hash with key/value pair inside %run_args{openqa_variables}.
Example:
    my %variables;
    $variables{HANA_SAR} = get_required_var(&quot;HANA_SAR&quot;);
    $variables{HANA_CLIENT_SAR} = get_required_var(&quot;HANA_CLIENT_SAR&quot;);
    qesap_yaml_replace(openqa_variables=&gt;\%variables);</code></pre>

<h3 id="qesap_execute">qesap_execute</h3>

<pre><code>qesap_execute(cmd =&gt; $qesap_script_cmd [, verbose =&gt; 1, cmd_options =&gt; $cmd_options] );
cmd_options - allows to append additional qesap.py commans arguments like &quot;qesap.py terraform -d&quot;
    Example:
    qesap_execute(cmd =&gt; &#39;terraform&#39;, cmd_options =&gt; &#39;-d&#39;) will result in:
    qesap.py terraform -d

Execute qesap glue script commands. Check project documentation for available options:
https://github.com/SUSE/qe-sap-deployment
Test only returns execution result, failure has to be handled by calling method.</code></pre>

<h3 id="qesap_get_inventory">qesap_get_inventory</h3>

<pre><code>Return the path of the generated inventory</code></pre>

<h3 id="qesap_get_nodes_number">qesap_get_nodes_number</h3>

<p>Get the number of cluster nodes from the inventory.yaml</p>

<h3 id="qesap_get_terraform_dir">qesap_get_terraform_dir</h3>

<pre><code>Return the path used by the qesap script as -chdir argument for terraform
It is useful if test would like to call terraform</code></pre>

<h3 id="qesap_prepare_env">qesap_prepare_env</h3>

<pre><code>qesap_prepare_env(variables=&gt;{dict with variables}, provider =&gt; &#39;aws&#39;);

Prepare terraform environment.
- creates file structures
- pulls git repository
- external config files
- installs pip requirements and OS packages
- generates config files with qesap script

For variables example see &#39;qesap_yaml_replace&#39;
Returns only result, failure handling has to be done by calling method.</code></pre>

<h3 id="qesap_ansible_cmd">qesap_ansible_cmd</h3>

<pre><code>Use Ansible to run a command remotely on some or all
the hosts from the inventory.yaml

qesap_prepare_env(cmd=&gt;{string}, provider =&gt; &#39;aws&#39;);</code></pre>

<dl>

<dt id="PROVIDER---Cloud-provider-name-used-to-find-the-inventory"><b>PROVIDER</b> - Cloud provider name, used to find the inventory</dt>
<dd>

</dd>
<dt id="CMD---command-to-run-remotely"><b>CMD</b> - command to run remotely</dt>
<dd>

</dd>
<dt id="USER---user-on-remote-host-default-to-cloudadmin"><b>USER</b> - user on remote host, default to &#39;cloudadmin&#39;</dt>
<dd>

</dd>
<dt id="FILTER---filter-hosts-in-the-inventory"><b>FILTER</b> - filter hosts in the inventory</dt>
<dd>

</dd>
<dt id="FAILOK---if-not-set-ansible-failure-result-in-die"><b>FAILOK</b> - if not set, ansible failure result in die</dt>
<dd>

</dd>
<dt id="HOST_KEYS_CHECK---if-set-add-some-extra-argument-to-the-Ansible-call-to-allow-contacting-hosts-not-in-the-KnownHost-list-yet.-This-enables-the-use-of-this-api-before-the-call-to-qesap.py-ansible"><b>HOST_KEYS_CHECK</b> - if set, add some extra argument to the Ansible call to allow contacting hosts not in the KnownHost list yet. This enables the use of this api before the call to qesap.py ansible</dt>
<dd>

</dd>
<dt id="TIMEOUT---default-90-secs"><b>TIMEOUT</b> - default 90 secs</dt>
<dd>

</dd>
<dt id="VERBOSE---enable-verbosity-default-is-OFF"><b>VERBOSE</b> - enable verbosity, default is OFF</dt>
<dd>

</dd>
</dl>

<h3 id="qesap_ansible_script_output">qesap_ansible_script_output</h3>

<pre><code>Use Ansible to run a command remotely and get the stdout.
Command could be executed with elevated privileges

qesap_ansible_script_output(cmd =&gt; &#39;crm status&#39;, provider =&gt; &#39;aws&#39;, host =&gt; &#39;vmhana01&#39;, root =&gt; 1);

It uses playbook data/sles4sap/script_output.yaml

1. ansible-playbook run the playbook
2. the playbook executes the command and redirects the output to file, both remotely
3. the playbook download the file locally
4. the file is read and stored to be returned to the caller

If local_file and local_path are specified, the output is written to file, return is the full path;
otherwise the return is the command output as string.</code></pre>

<dl>

<dt id="PROVIDER---Cloud-provider-name-used-to-find-the-inventory1"><b>PROVIDER</b> - Cloud provider name, used to find the inventory</dt>
<dd>

</dd>
<dt id="CMD---command-to-run-remotely1"><b>CMD</b> - command to run remotely</dt>
<dd>

</dd>
<dt id="HOST---filter-hosts-in-the-inventory"><b>HOST</b> - filter hosts in the inventory</dt>
<dd>

</dd>
<dt id="USER---user-on-remote-host-default-to-cloudadmin1"><b>USER</b> - user on remote host, default to &#39;cloudadmin&#39;</dt>
<dd>

</dd>
<dt id="ROOT---1-to-enable-remote-execution-with-elevated-user-default-to-0"><b>ROOT</b> - 1 to enable remote execution with elevated user, default to 0</dt>
<dd>

</dd>
<dt id="FAILOK---if-not-set-ansible-failure-result-in-die1"><b>FAILOK</b> - if not set, ansible failure result in die</dt>
<dd>

</dd>
<dt id="LOCAL_FILE---filter-hosts-in-the-inventory"><b>LOCAL_FILE</b> - filter hosts in the inventory</dt>
<dd>

</dd>
<dt id="LOCAL_PATH---filter-hosts-in-the-inventory"><b>LOCAL_PATH</b> - filter hosts in the inventory</dt>
<dd>

</dd>
</dl>

<h3 id="qesap_create_aws_credentials">qesap_create_aws_credentials</h3>

<pre><code>Creates a AWS credentials file as required by QE-SAP Terraform deployment code.</code></pre>

<h3 id="qesap_create_aws_config">qesap_create_aws_config</h3>

<pre><code>Creates a AWS config file in ~/.aws as required by the QE-SAP Terraform &amp; Ansible deployment code.</code></pre>

<h3 id="qesap_remote_hana_public_ips">qesap_remote_hana_public_ips</h3>

<pre><code>Return a list of the public IP addresses of the systems deployed by qesapdeployment, as reported
by C&lt;terraform output&gt;. Needs to run after C&lt;qesap_execute(cmd =&gt; &#39;terraform&#39;);&gt; call.</code></pre>

<h3 id="qesap_wait_for_ssh">qesap_wait_for_ssh</h3>

<pre><code>Probe specified port on the remote host each 5sec till response.
Return -1 in case of timeout
Return total time of retry loop in case of pass.</code></pre>

<dl>

<dt id="HOST---IP-of-the-host-to-probe"><b>HOST</b> - IP of the host to probe</dt>
<dd>

</dd>
<dt id="TIMEOUT---time-to-wait-before-to-give-up-default-is-10mins"><b>TIMEOUT</b> - time to wait before to give up, default is 10mins</dt>
<dd>

</dd>
<dt id="PORT---port-to-probe-default-is-22"><b>PORT</b> - port to probe, default is 22</dt>
<dd>

</dd>
</dl>

<h3 id="qesap_cluster_log_cmds">qesap_cluster_log_cmds</h3>

<pre><code>List of commands to collect logs from a deployed cluster</code></pre>

<h3 id="qesap_cluster_logs">qesap_cluster_logs</h3>

<pre><code>Collect logs from a deployed cluster</code></pre>

<h3 id="qesap_az_get_vnet">qesap_az_get_vnet</h3>

<p>Return the output of az network vnet list =over 1</p>

<dl>

<dt id="RESOURCE_GROUP---resource-group-name-to-query"><b>RESOURCE_GROUP</b> - resource group name to query</dt>
<dd>

</dd>
</dl>

<h3 id="qesap_calculate_deployment_name">qesap_calculate_deployment_name</h3>

<p>Compose the deployment name. It always has the JobId</p>

<dl>

<dt id="PREFIX---optional-substring-prepend-in-front-of-the-job-id"><b>PREFIX</b> - optional substring prepend in front of the job id</dt>
<dd>

</dd>
</dl>

<h3 id="qesap_az_get_resource_group">qesap_az_get_resource_group</h3>

<p>Query and return the resource group used by the qe-sap-deployment</p>

<dl>

<dt id="SUBSTRING---optional-substring-to-be-used-with-aditional-grep-at-the-end-of-the-command"><b>SUBSTRING</b> - optional substring to be used with aditional grep at the end of the command</dt>
<dd>

</dd>
</dl>

<h3 id="qesap_calculate_az_address_range">qesap_calculate_az_address_range</h3>

<p>Calculate the vnet and subnet address ranges. The format is 10.ip2.ip3.0/21 and /24 respectively. ip2 and ip3 are calculated using the slot number as seed.</p>

<dl>

<dt id="SLOT---integer-to-be-used-as-seed-in-calculating-addresses"><b>SLOT</b> - integer to be used as seed in calculating addresses</dt>
<dd>

</dd>
</dl>

<h3 id="qesap_az_vnet_peering">qesap_az_vnet_peering</h3>

<pre><code>Create a pair of network peering between
the two provided deployments.</code></pre>

<dl>

<dt id="SOURCE_GROUP---resource-group-of-source"><b>SOURCE_GROUP</b> - resource group of source</dt>
<dd>

</dd>
<dt id="TARGET_GROUP---resource-group-of-target"><b>TARGET_GROUP</b> - resource group of target</dt>
<dd>

</dd>
<dt id="TIMEOUT---default-is-5-mins"><b>TIMEOUT</b> - default is 5 mins</dt>
<dd>

</dd>
</dl>

<h3 id="qesap_az_vnet_peering_delete">qesap_az_vnet_peering_delete</h3>

<pre><code>Delete all the network peering between the two provided deploymnets.</code></pre>

<dl>

<dt id="SOURCE_GROUP---resource-group-of-source.-This-parameter-is-optional-if-not-provided-the-related-peering-will-be-ignored"><b>SOURCE_GROUP</b> - resource group of source. This parameter is optional, if not provided the related peering will be ignored.</dt>
<dd>

</dd>
<dt id="TARGET_GROUP---resource-group-of-target.-This-parameter-is-mandatory-and-the-associated-resource-group-is-supposed-to-still-exist"><b>TARGET_GROUP</b> - resource group of target. This parameter is mandatory and the associated resource group is supposed to still exist.</dt>
<dd>

</dd>
<dt id="TIMEOUT---default-is-5-mins1"><b>TIMEOUT</b> - default is 5 mins</dt>
<dd>

</dd>
</dl>

<h3 id="qesap_az_get_peering_name">qesap_az_get_peering_name</h3>

<pre><code>Search for all network peering related to both:
 - resource group related to the current job
 - the provided resource group.
Returns the peering name or
empty string if a peering doesn&#39;t exist</code></pre>

<dl>

<dt id="RESOURCE_GROUP---resource-group-connected-to-the-peering"><b>RESOURCE_GROUP</b> - resource group connected to the peering</dt>
<dd>

</dd>
</dl>

<h3 id="qesap_add_server_to_hosts">qesap_add_server_to_hosts</h3>

<pre><code>Adds a &#39;ip -&gt; name&#39; pair in the end of /etc/hosts in the hosts</code></pre>

<dl>

<dt id="IP---ip-of-server-to-add-to-hosts"><b>IP</b> - ip of server to add to hosts</dt>
<dd>

</dd>
<dt id="NAME---name-of-server-to-add-to-hosts"><b>NAME</b> - name of server to add to hosts</dt>
<dd>

</dd>
</dl>

<h3 id="qesap_import_instances">qesap_import_instances</h3>

<pre><code>Downloads assets required for re-using infrastructure from previously exported test.
qesap_import_instances(&lt;$test_id&gt;)</code></pre>

<dl>

<dt id="test_id---OpenQA-test-ID-from-a-test-previously-run-with-QESAP_DEPLOYMENT_IMPORT-1-and-infrastructure-still-being-up-and-running"><b>$test_id</b> - OpenQA test ID from a test previously run with &quot;QESAP_DEPLOYMENT_IMPORT=1&quot; and infrastructure still being up and running</dt>
<dd>

</dd>
</dl>

<h3 id="qesap_export_instances">qesap_export_instances</h3>

<pre><code>Downloads assets required for re-using infrastructure from previously exported test.
qesap_export_instances()</code></pre>

<h1 id="POD-ERRORS">POD ERRORS</h1>

<p>Hey! <b>The above document had some coding errors, which are explained below:</b></p>

<dl>

<dt id="Around-line-732">Around line 732:</dt>
<dd>

<p>&#39;=item&#39; outside of any &#39;=over&#39;</p>

</dd>
</dl>


</body>

</html>


