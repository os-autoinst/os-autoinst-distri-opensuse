From 6d28009edbc926d03c7fdf30148a3898a1f83d8e Mon Sep 17 00:00:00 2001
From: Ricardo Branco <rbranco@suse.de>
Date: Fri, 2 Jan 2026 17:22:05 +0100
Subject: [PATCH] test/e2e: Skip privileged container test if NoNewPrivs is set

On systems with NoNewPrivs set, this test fails.
https://www.thkukuk.de/blog/no_new_privs/

Signed-off-by: Ricardo Branco <rbranco@suse.de>
---
 test/e2e/run_privileged_test.go | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/test/e2e/run_privileged_test.go b/test/e2e/run_privileged_test.go
index 967168d123b..2c9555754c3 100644
--- a/test/e2e/run_privileged_test.go
+++ b/test/e2e/run_privileged_test.go
@@ -143,16 +143,23 @@ var _ = Describe("Podman privileged container tests", func() {
 			Skip("Can't determine NoNewPrivs")
 		}
 
+		fields := strings.Fields(cap.OutputToString())
+		if fields[1] != "0" {
+			Skip("NoNewPrivs set")
+		}
+
 		session := podmanTest.Podman([]string{"run", BB, "grep", "NoNewPrivs", "/proc/self/status"})
 		session.WaitWithDefaultTimeout()
 		Expect(session).Should(ExitCleanly())
 
-		privs := strings.Split(session.OutputToString(), ":")
+		privs := strings.Fields(session.OutputToString())
+		Expect(privs[1]).To(Equal("0"), "NoNewPrivs should be 0 without security-opt")
+
 		session = podmanTest.Podman([]string{"run", "--security-opt", "no-new-privileges", BB, "grep", "NoNewPrivs", "/proc/self/status"})
 		session.WaitWithDefaultTimeout()
 		Expect(session).Should(ExitCleanly())
 
-		noprivs := strings.Split(session.OutputToString(), ":")
-		Expect(privs[1]).To(Not(Equal(noprivs[1])))
+		noprivs := strings.Fields(session.OutputToString())
+		Expect(noprivs[1]).To(Equal("1"), "NoNewPrivs should be 1 with security-opt")
 	})
 })
